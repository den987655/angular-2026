**ГЛАВА 8.**  
Канонический пример: интернет-магазин по feature-подходу

**Введение**  
Теория хороша, но архитектура проверяется только на реальном проекте.  

Интернет-магазин — идеальный полигон 2025 года:

- 50+ страниц и экранов,  
- сложные фичи (auth, catalog, product, cart, checkout, orders, profile, search),  
- кросс-фичевое взаимодействие,  
- глобальное состояние,  
- SEO-критичные страницы,  
- server-first рантайм,  
- асинхронные цепочки,  
- реальные бизнес-правила и ограничения.

Если эта структура выдерживает интернет-магазин — она выдержит любой проект 2025+.

**1. Домен: какие фичи есть в типичном магазине**

Базовый набор (минимально жизнеспособный продукт):

1. Auth (регистрация, логин, восстановление пароля, профиль)  
2. Catalog (список товаров, категории, фильтры, сортировка)  
3. Product (карточка товара, галерея, отзывы, наличие)  
4. Cart (корзина, модификаторы, промокоды)  
5. Checkout (оформление заказа, оплата, доставка)  
6. Orders (история заказов, детали, статусы)  
7. Profile (личный кабинет, адреса, бонусы)  
8. Search (поиск по сайту)  
9. Layout / Shell (шапка, футер, навигация, модалки)

Дополнительно, но почти всегда:  
- Favorites  
- Comparison  
- Reviews  
- Recommendations  
- Admin (но мы его не трогаем)

**2. Эталонная структура проекта (ноябрь 2025)**

```
src/
└── app/
    ├── core/                      # ядро, подключается один раз
    │   ├── guards/              # guard'ы (auth, roles)
    │   ├── interceptors/          # http-interceptors
    │   ├── services/            # глобальные (analytics, config)
    │   ├── layout/               # DefaultLayout, AdminLayout, AuthLayout
    │   ├── state/              # глобальный store (только то, что нужно всем)
    │   ├── utils/               # pipes, directives, pure-ts утилиты
    │   ├── api/                 # базовый ApiClient, error-handler
    │   └── app.routes.ts        # корневой роутер + lazy-load features
    │
    ├── shared/                    # всё, что используется ≥2 фичами
    │   ├── ui/                  # Button, Card, Modal, Dropdown, Tooltip и т.д.
    │   ├── directives/          # ClickOutside, IntersectionObserver и т.д.
    │   ├── pipes/                # DatePipe, CurrencyPipe и т.д.
    │   ├── models/               # чистые TS-типы, которые не относятся к одной фиче (Address, Money, Phone и т.д.)
    │   └── shared.module.ts     # (если ещё нужен NgModule для legacy)
    │
    └── features/                  # ВСЁ, что относится к бизнес-логике
        ├── auth/
        ├── catalog/
        ├── product/
        ├── cart/
        ├── checkout/
        ├── orders/
        ├── profile/
        └── search/
```

Это канон 2025 года.  
Никаких src/assets, assets в public/  
Никаких global components/ в app/ — всё, что не core или shared — в features/

**3. Каноническая структура одной фичи (2025)**

``` 
features/
└── catalog/
    ├── pages/
    │   catalog.page.ts
    catalog.routes.ts
    │
    ├── ui/                        # только UI этой фичи
    │   catalog-list.component.ts
    catalog-item.component.ts
    filters-panel.component.ts
    product-card.component.ts
    │
    ├── components/              # если нужно (редко) — только если UI очень большой
    │
    ├── state/                    # SignalStore + фасад
    catalog.store.ts          # SignalStore (withEffects если нужно)
    catalog.facade.ts         # тонкий фасад (часто не нужен, если store достаточно)
    catalog.selectors.ts       # если сложные селекторы вынести
    │
    ├── services/                # только HTTP и чистый TS
    │   catalog.api.ts           # HttpClient + маппинг
    catalog.service.ts         # если нужен классический сервис (редко)
    │
    ├── domain/                   # чистый TS, без Angular
    product.model.ts
    product.types.ts
    catalog.mappers.ts
    catalog.types.ts         # если нужно отдельно от model
    │
    ├── catalog.routes.ts        # lazy-loadable routes
    └── index.ts                  # public api фичи (export * from './state'; export * from './ui';)
```

Это жёсткий канон 2025 года.

Всё, что можно вынести в shared — выносим сразу.

**4. Полный разбор ключевых фич**

**Auth** (глобальная по своей природе, но в features/)

```
auth/
   pages/
      login.page.ts
      register.page.ts
      recover-password.page.ts
      profile.page.ts
   ui/
      auth-form.component.ts
      avatar-upload.component.ts
   state/
      auth.store.ts             # глобальный! (единственный в features/auth/state)
   services/
      auth.facade.ts            # AuthFacade (самый тонкий)
      token.service.ts          # localStorage/SessionStorage
   api/
      auth.api.ts
   domain/
      user.model.ts
      auth.types.ts
```

Особенности:
- auth.store в core/state, но в 2025 — в features/auth/state, но мы делаем в core/state/auth.store.ts
- UI минимальный, всё в shared/ui где возможно

**Catalog**

```
catalog/
   pages/
      catalog.page.ts
      category-page (если отдельно)
   ui/
      product-card.component.ts
      filters-panel.component.ts
      catalog-list.component.ts
      product-skeleton.component.ts
   state/
      catalog.store.ts            # SignalStore с фильтрами, сортировкой, pagination
   services/
      catalog.facade.ts           # основной фасад
   api/
      catalog.api.ts                 # CatalogApiService
   domain/
      product.model.ts
      catalog.types.ts
      catalog.mappers.ts
```

Особенности:
- SSR/SSG обязателен для catalog.page
- 90% трафика — здесь → перформанс критичен

**Product (самая SEO-важная страница)**

```
product/
   pages/
      product-details.page.ts
   ui/
      gallery.component.ts
      reviews-list.component.ts
      add-to-cart-button.component.ts
      product-info.component.ts
   state/
      product.store.ts            # кэширование, availability, selectedVariant
   services/
      product.facade.ts
   api/
      product.api.ts
   domain/
      product.model.ts
      product-variant.model.ts
```

Особенности:
- SSR обязателен
- Store для кэширования (чтобы не грузить один и тот же товар при переходах)
-обратно)

**Cart (самая сложная бизнес-логика)**

```
cart/
   pages/
      cart.page.ts
   ui/
      cart-list.component.ts
      cart-item.component.ts
      cart-summary.component.ts
      promo-code-input.component.ts
   state/
      cart.store.ts              # SignalStore с items, totals, promo, checkoutStatus
   services/
      cart.facade.ts             # основной фасад
   api/
      cart.api.ts              # CartApiService
   domain/
      cart-item.model.ts
      cart.types.ts
```

Особенности:
- состояние переживает навигацию → store обязателен
- глобально доступна, но остаётся в своей фиче (не в глобальном сторе)

**Checkout (самый сложный процесс)**

```
checkout/
   pages/
      checkout.page.ts
      delivery-step.component.ts (если step-by-step)
   ui/
      address-form.component.ts
      payment-method.component.ts
      order-summary.component.ts
   state/
      checkout.store.ts         # весь multi-step процесс
   services/
      checkout.facade.ts
   api/
      checkout.api.ts
   domain/
      order.model.ts
      delivery.model.ts
```

Особенности:
- много шагов → SignalStore с step management
- частичная гидрация (шапка и футер гидрируются сразу, шаги — по мере)

**Orders & Profile**

```
orders/
   pages/
      orders-list.page.ts
      order-details.page.ts
   state/
      orders.store.ts            # кэширование списка
   orders.facade.ts
   orders.api.ts

profile/
   pages/
      profile.page.ts
      addresses/
      bonuses.page.ts
   state/
      profile.store.ts (или без, если всё в auth + orders)
```

**5. Как фичи связываются между собой**

Только так:

- UI-компонент → фасад своей фичи → (при необходимости) фасад другой фичи  
  Пример: ProductCardComponent → CartFacade.addItem(product)

- Через глобальный store — только действительно глобальные данные (auth.userId, settings.currency)

Запрещено:
- прямые импорты state из другой фичи
- импорты компонентов из features/*/ui в другую фичу (только через shared/ui)

Это жёсткое правило 2025 года.

**6. Глобальный store — какой он должен быть в 2025**

Он должен быть крошечным:

core/state/
   auth.state.ts          # AuthState (user, tokens, isAuthenticated)
   settings.state.ts        # theme, language, currency, featureFlags

Больше ничего.
Если у вас в глобальном сторе больше 15–20 полей — вы что-то делаете неправильно.

Cart? Нет.
Catalog filters? Нет.
Только то, что нужно одновременно в разных фичах без исключений.

**7. Полная карта проекта (финальная схема 2025)**

```
src/app/
├── core/
│   ├── api/
│   ├── guards/
│   ├── interceptors/
│   ├── layout/
│   │   ├── default-layout.component.ts
│   │   admin-layout.component.ts
│   │   auth-layout.component.ts
│   ├── state/
│   │   auth.store.ts
│   │   settings.store.ts
│   ├── services/
│   ├── utils/
│   └── app.routes.ts
│
├── shared/
│   ├── ui/                  # Card, Button, Modal, Input, Select, Tooltip, Skeleton, Avatar и т.д.
│   ├── directives/
│   ├── pipes/
│   ├── pipes/
│   └── models/               # Money, Phone, Email, UUID и т.д.
│
└── features/
    ├── auth/
    ├── catalog/
    ├── product/
    ├── cart/
    ├── checkout/
    ├── orders/
    ├── profile/
    └── search/
```    

Это не рекомендация.
Это стандарт, который уже 2025 года.

**8. Почему это работает с server-first**

- Публичные фичи (catalog, product) → SSR/SSG без изменений  
- Личные фичи (cart, checkout, orders) → CSR + partial hydration  
- Layout → всегда SSR-рендерится (шапка, футер, корзина виджет — гидрируется отдельно)

Всё работает из коробки в Angular 19+ с @defer и partial hydration.

**9. Переносимость фичи**

Любая фича — полностью независимая:

src/features/catalog/
└── everything

Её можно вынести в npm-пакет или отдельный репозиторий за 30 минут.
Можно подключить в монолит.
Можно в микрофронтенд.
Это уже не мечта 2018 года — это реальность 2025.

**Итог главы 8**

Сигнал  
Мы больше не проектируем вслепую.  
Есть проверенная, живая структура, которая уже работает в продакшене 2025 года.

Паттерн  
Фичи — автономные модули с полной ответственностью (UI + State + API + Domain).

Системные последствия  
- Новичок открывает проект — сразу понимает весь продукт за часы  
- Команда 10 человек работает без конфликтов  
- SEO-страницы летают  
- SSR/SSG работает без костылей  
- Проект живёт 5–7 лет без рефакторинга без полной переписывания

Практические шаги (прямо сейчас 2025)

1. Создать папки core/, shared/, features/  
2. Вынести всё, что можно в shared сразу  
3. Перенести все страницы в features/*/pages  
4. Сделать фасады обязательными для всех новых фич  
5. Включить hydration и @defer в шаблонах  
6. Проверить, что корзина виджет работает везде без ошибок

Риски  
- Слишком крупные фичи → теряется смысл автономности → делить на подфичи  
- Слишком мелкие → overhead папок → не делать подфичи, пока фича < 30–40 файлов

Что мониторить в 2025–2026  
- Angular RSC-подходы (если появится стабильный RSC от Angular)  
- Angular DevKit schematics для генерации фичей (скоро будет)  
- Edge-рендеринг интеграции (Vercel, Cloudflare Workers)  
- Автоматические анализаторы (если появятся)